import{c as W,d as B,a0 as Y,n as H,r as G,ag as pe,E as q,g as L,V as N,W as fe,a as t,aj as J,ak as U,aw as oe,aR as we,a1 as ie,G as he,a2 as _e,ah as xe,a5 as be,i as K,a6 as M,at as ye,t as A,aK as ne,m as D,ab as Q,X,Z as ze,aa as te,aM as ke,I as O,N as Pe,e as Z,w as re,aD as le,aA as Ie,aS as se,$ as Se,P as Ce,aT as Re,ad as Te,ae as Ae,az as Fe}from"./index.3ed4ba67.js";import{a as De,S as Xe}from"./index.5b09449e.js";import{I as ce}from"./index.7c29d49f.js";import{m as Le,u as Ue}from"./mount-component.304d8a99.js";const ee=e=>Math.sqrt((e[0].clientX-e[1].clientX)**2+(e[0].clientY-e[1].clientY)**2),j=W("image-preview")[1];var Ye=B({props:{src:String,show:Boolean,active:Number,minZoom:Y(H),maxZoom:Y(H),rootWidth:Y(Number),rootHeight:Y(Number)},emits:["scale","close","longPress"],setup(e,{emit:n,slots:s}){const a=G({scale:1,moveX:0,moveY:0,moving:!1,zooming:!1,imageRatio:0,displayWidth:0,displayHeight:0}),r=pe(),w=q(),y=L(()=>{const{rootWidth:o,rootHeight:v}=e,u=v/o;return a.imageRatio>u}),P=L(()=>{const{scale:o,moveX:v,moveY:u,moving:k,zooming:R}=a,E={transitionDuration:R||k?"0s":".3s"};if(o!==1){const me=v/o,ge=u/o;E.transform=`scale(${o}, ${o}) translate(${me}px, ${ge}px)`}return E}),_=L(()=>{if(a.imageRatio){const{rootWidth:o,rootHeight:v}=e,u=y.value?v/a.imageRatio:o;return Math.max(0,(a.scale*u-o)/2)}return 0}),l=L(()=>{if(a.imageRatio){const{rootWidth:o,rootHeight:v}=e,u=y.value?v:o*a.imageRatio;return Math.max(0,(a.scale*u-v)/2)}return 0}),m=o=>{o=U(o,+e.minZoom,+e.maxZoom+1),o!==a.scale&&(a.scale=o,n("scale",{scale:o,index:e.active}))},x=()=>{m(1),a.moveX=0,a.moveY=0},f=()=>{const o=a.scale>1?1:2;m(o),a.moveX=0,a.moveY=0};let I,T,C,c,z,b,$;const i=o=>{const{touches:v}=o,{offsetX:u}=r;r.start(o),I=v.length,T=a.moveX,C=a.moveY,$=Date.now(),a.moving=I===1&&a.scale!==1,a.zooming=I===2&&!u.value,a.zooming&&(c=a.scale,z=ee(o.touches))},d=o=>{const{touches:v}=o;if(r.move(o),(a.moving||a.zooming)&&J(o,!0),a.moving){const{deltaX:u,deltaY:k}=r,R=u.value+T,E=k.value+C;a.moveX=U(R,-_.value,_.value),a.moveY=U(E,-l.value,l.value)}if(a.zooming&&v.length===2){const u=ee(v),k=c*u/z;m(k)}},h=()=>{if(I>1)return;const{offsetX:o,offsetY:v}=r,u=Date.now()-$,k=250,R=5;o.value<R&&v.value<R&&(u<k?b?(clearTimeout(b),b=null,f()):b=setTimeout(()=>{n("close"),b=null},k):u>we&&n("longPress"))},g=o=>{let v=!1;(a.moving||a.zooming)&&(v=!0,a.moving&&T===a.moveX&&C===a.moveY&&(v=!1),o.touches.length||(a.zooming&&(a.moveX=U(a.moveX,-_.value,_.value),a.moveY=U(a.moveY,-l.value,l.value),a.zooming=!1),a.moving=!1,T=0,C=0,c=1,a.scale<1&&x(),a.scale>e.maxZoom&&(a.scale=+e.maxZoom))),J(o,v),h(),r.reset()},S=o=>{const{naturalWidth:v,naturalHeight:u}=o.target;a.imageRatio=u/v};return N(()=>e.active,x),N(()=>e.show,o=>{o||x()}),fe("touchmove",d,{target:L(()=>{var o;return(o=w.value)==null?void 0:o.$el})}),()=>{const o={loading:()=>t(oe,{type:"spinner"},null)};return t(De,{ref:w,class:j("swipe-item"),onTouchstartPassive:i,onTouchend:g,onTouchcancel:g},{default:()=>[s.image?t("div",{class:j("image-wrap")},[s.image({src:e.src})]):t(ce,{src:e.src,fit:"contain",class:j("image",{vertical:y.value}),style:P.value,onLoad:S},o)]})}}});const[Me,F]=W("image-preview"),Ne=["show","transition","overlayStyle","closeOnPopstate"],Oe={show:Boolean,loop:A,images:ne(),minZoom:D(1/3),maxZoom:D(3),overlay:A,closeable:Boolean,showIndex:A,className:Q,closeIcon:X("clear"),transition:String,beforeClose:Function,overlayClass:Q,overlayStyle:Object,swipeDuration:D(300),startPosition:D(0),showIndicators:Boolean,closeOnPopstate:A,closeIconPosition:X("top-right")};var ve=B({name:Me,props:Oe,emits:["scale","close","closed","change","longPress","update:show"],setup(e,{emit:n,slots:s}){const a=q(),r=G({active:0,rootWidth:0,rootHeight:0}),w=()=>{if(a.value){const c=ze(a.value.$el);r.rootWidth=c.width,r.rootHeight=c.height,a.value.resize()}},y=c=>n("scale",c),P=c=>n("update:show",c),_=()=>{te(e.beforeClose,{args:[r.active],done:()=>P(!1)})},l=c=>{c!==r.active&&(r.active=c,n("change",c))},m=()=>{if(e.showIndex)return t("div",{class:F("index")},[s.index?s.index({index:r.active}):`${r.active+1} / ${e.images.length}`])},x=()=>{if(s.cover)return t("div",{class:F("cover")},[s.cover()])},f=()=>t(Xe,{ref:a,lazyRender:!0,loop:e.loop,class:F("swipe"),duration:e.swipeDuration,initialSwipe:e.startPosition,showIndicators:e.showIndicators,indicatorColor:"white",onChange:l},{default:()=>[e.images.map((c,z)=>t(Ye,{src:c,show:e.show,active:r.active,maxZoom:e.maxZoom,minZoom:e.minZoom,rootWidth:r.rootWidth,rootHeight:r.rootHeight,onScale:y,onClose:_,onLongPress:()=>n("longPress",{index:z})},{image:s.image}))]}),I=()=>{if(e.closeable)return t(O,{role:"button",name:e.closeIcon,class:[F("close-icon",e.closeIconPosition),ke],onClick:_},null)},T=()=>n("closed"),C=(c,z)=>{var b;return(b=a.value)==null?void 0:b.swipeTo(c,z)};return ie({swipeTo:C}),he(w),N([_e,xe],w),N(()=>e.startPosition,c=>l(+c)),N(()=>e.show,c=>{const{images:z,startPosition:b}=e;c?(l(+b),be(()=>{w(),C(+b,{immediate:!0})})):n("close",{index:r.active,url:z[r.active]})}),()=>t(ye,K({class:[F(),e.className],overlayClass:[F("overlay"),e.overlayClass],onClosed:T,"onUpdate:show":P},M(e,Ne)),{default:()=>[I(),f(),m(),x()]})}});let V;const $e={loop:!0,images:[],maxZoom:3,minZoom:1/3,onScale:void 0,onClose:void 0,onChange:void 0,teleport:"body",className:"",showIndex:!0,closeable:!1,closeIcon:"clear",transition:void 0,beforeClose:void 0,overlayStyle:void 0,overlayClass:void 0,startPosition:0,swipeDuration:300,showIndicators:!1,closeOnPopstate:!0,closeIconPosition:"top-right"};function Ee(){({instance:V}=Le({setup(){const{state:e,toggle:n}=Ue(),s=()=>{e.images=[]};return()=>t(ve,K(e,{onClosed:s,"onUpdate:show":n}),null)}}))}const Ve=(e,n=0)=>{if(!!Pe)return V||Ee(),e=Array.isArray(e)?{images:e,startPosition:n}:e,V.open(Z({},$e,e)),V};re(ve);const[Ze,p,Be]=W("uploader");function ae(e,n){return new Promise(s=>{if(n==="file"){s();return}const a=new FileReader;a.onload=r=>{s(r.target.result)},n==="dataUrl"?a.readAsDataURL(e):n==="text"&&a.readAsText(e)})}function de(e,n){return le(e).some(s=>s.file?Ie(n)?n(s.file):s.file.size>n:!1)}function je(e,n){const s=[],a=[];return e.forEach(r=>{de(r,n)?a.push(r):s.push(r)}),{valid:s,invalid:a}}const He=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg)/i,We=e=>He.test(e);function ue(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?We(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var Ge=B({props:{name:H,item:Y(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview"],setup(e,{emit:n,slots:s}){const a=()=>{const{status:l,message:m}=e.item;if(l==="uploading"||l==="failed"){const x=l==="failed"?t(O,{name:"close",class:p("mask-icon")},null):t(oe,{class:p("loading")},null),f=Se(m)&&m!=="";return t("div",{class:p("mask")},[x,f&&t("div",{class:p("mask-message")},[m])])}},r=l=>{const{name:m,item:x,index:f,beforeDelete:I}=e;l.stopPropagation(),te(I,{args:[x,{name:m,index:f}],done:()=>n("delete")})},w=()=>n("preview"),y=()=>{if(e.deletable&&e.item.status!=="uploading"){const l=s["preview-delete"];return t("div",{role:"button",class:p("preview-delete",{shadow:!l}),tabindex:0,"aria-label":Be("delete"),onClick:r},[l?l():t(O,{name:"cross",class:p("preview-delete-icon")},null)])}},P=()=>{if(s["preview-cover"]){const{index:l,item:m}=e;return t("div",{class:p("preview-cover")},[s["preview-cover"](Z({index:l},m))])}},_=()=>{const{item:l,lazyLoad:m,imageFit:x,previewSize:f}=e;return ue(l)?t(ce,{fit:x,src:l.content||l.url,class:p("preview-image"),width:Array.isArray(f)?f[0]:f,height:Array.isArray(f)?f[1]:f,lazyLoad:m,onClick:w},{default:P}):t("div",{class:p("file"),style:se(e.previewSize)},[t(O,{class:p("file-icon"),name:"description"},null),t("div",{class:[p("file-name"),"van-ellipsis"]},[l.file?l.file.name:l.url]),P()])};return()=>t("div",{class:p("preview")},[_(),a(),y()])}});const qe={name:D(""),accept:X("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:D(1/0),imageFit:X("cover"),resultType:X("dataUrl"),uploadIcon:X("photograph"),uploadText:String,deletable:A,afterRead:Function,showUpload:A,modelValue:ne(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:A,previewOptions:Object,previewFullImage:A,maxSize:{type:[Number,String,Function],default:1/0}};var Ke=B({name:Ze,props:qe,emits:["delete","oversize","clickUpload","closePreview","clickPreview","update:modelValue"],setup(e,{emit:n,slots:s}){const a=q(),r=[],w=(i=e.modelValue.length)=>({name:e.name,index:i}),y=()=>{a.value&&(a.value.value="")},P=i=>{if(y(),de(i,e.maxSize))if(Array.isArray(i)){const d=je(i,e.maxSize);if(i=d.valid,n("oversize",d.invalid,w()),!i.length)return}else{n("oversize",i,w());return}i=G(i),n("update:modelValue",[...e.modelValue,...le(i)]),e.afterRead&&e.afterRead(i,w())},_=i=>{const{maxCount:d,modelValue:h,resultType:g}=e;if(Array.isArray(i)){const S=+d-h.length;i.length>S&&(i=i.slice(0,S)),Promise.all(i.map(o=>ae(o,g))).then(o=>{const v=i.map((u,k)=>{const R={file:u,status:"",message:""};return o[k]&&(R.content=o[k]),R});P(v)})}else ae(i,g).then(S=>{const o={file:i,status:"",message:""};S&&(o.content=S),P(o)})},l=i=>{const{files:d}=i.target;if(e.disabled||!d||!d.length)return;const h=d.length===1?d[0]:[].slice.call(d);if(e.beforeRead){const g=e.beforeRead(h,w());if(!g){y();return}if(Fe(g)){g.then(S=>{_(S||h)}).catch(y);return}}_(h)};let m;const x=()=>n("closePreview"),f=i=>{if(e.previewFullImage){const d=e.modelValue.filter(ue),h=d.map(g=>(g.file&&!g.url&&g.status!=="failed"&&(g.url=URL.createObjectURL(g.file),r.push(g.url)),g.url)).filter(Boolean);m=Ve(Z({images:h,startPosition:d.indexOf(i),onClose:x},e.previewOptions))}},I=()=>{m&&m.close()},T=(i,d)=>{const h=e.modelValue.slice(0);h.splice(d,1),n("update:modelValue",h),n("delete",i,w(d))},C=(i,d)=>{const h=["imageFit","deletable","previewSize","beforeDelete"],g=Z(M(e,h),M(i,h,!0));return t(Ge,K({item:i,index:d,onClick:()=>n("clickPreview",i,w(d)),onDelete:()=>T(i,d),onPreview:()=>f(i)},M(e,["name","lazyLoad"]),g),M(s,["preview-cover","preview-delete"]))},c=()=>{if(e.previewImage)return e.modelValue.map(C)},z=i=>n("clickUpload",i),b=()=>{if(e.modelValue.length>=e.maxCount)return;const i=e.readonly?null:t("input",{ref:a,type:"file",class:p("input"),accept:e.accept,capture:e.capture,multiple:e.multiple,disabled:e.disabled,onChange:l},null);return s.default?t("div",{class:p("input-wrapper"),onClick:z},[s.default(),i]):Te(t("div",{class:p("upload",{readonly:e.readonly}),style:se(e.previewSize),onClick:z},[t(O,{name:e.uploadIcon,class:p("upload-icon")},null),e.uploadText&&t("span",{class:p("upload-text")},[e.uploadText]),i]),[[Ae,e.showUpload]])},$=()=>{a.value&&!e.disabled&&a.value.click()};return Ce(()=>{r.forEach(i=>URL.revokeObjectURL(i))}),ie({chooseFile:$,closeImagePreview:I}),Re(()=>e.modelValue),()=>t("div",{class:p()},[t("div",{class:p("wrapper",{disabled:e.disabled})},[c(),b()])])}});const oa=re(Ke);export{oa as U};
